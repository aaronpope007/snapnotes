import { useState } from 'react';
import Box from '@mui/material/Box';
import Typography from '@mui/material/Typography';
import IconButton from '@mui/material/IconButton';
import TextField from '@mui/material/TextField';
import Button from '@mui/material/Button';
import Collapse from '@mui/material/Collapse';
import AddIcon from '@mui/icons-material/Add';
import DeleteIcon from '@mui/icons-material/Delete';
import ExpandMoreIcon from '@mui/icons-material/ExpandMore';
import ExpandLessIcon from '@mui/icons-material/ExpandLess';
import { RichNoteRenderer } from './RichNoteRenderer';

interface ExploitsDisplayProps {
  exploits: string[];
  onAddExploit?: (text: string) => Promise<void>;
  onDeleteExploit?: (index: number) => Promise<void>;
  saving?: boolean;
  inline?: boolean;
}

const EXPLOIT_COLOR = '#ffb74d';

export function ExploitsDisplay({
  exploits,
  onAddExploit,
  onDeleteExploit,
  saving = false,
  inline = false,
}: ExploitsDisplayProps) {
  const [expanded, setExpanded] = useState(true);
  const [adding, setAdding] = useState(false);
  const [value, setValue] = useState('');

  const handleAdd = async () => {
    const trimmed = value.trim();
    if (!trimmed || !onAddExploit) return;
    await onAddExploit(trimmed);
    setValue('');
    setAdding(false);
  };

  const summary = (exploits?.length ?? 0) > 0
    ? `${exploits!.length} exploit${exploits!.length === 1 ? '' : 's'}`
    : 'None';

  return (
    <Box sx={{ mb: inline ? 0 : 2, flexShrink: inline ? 0 : undefined }}>
      <Box
        component="button"
        onClick={() => setExpanded((e) => !e)}
        sx={{
          display: 'flex',
          alignItems: 'center',
          gap: 0.5,
          border: 'none',
          background: 'none',
          cursor: 'pointer',
          p: 0,
          mb: 0.5,
          textAlign: 'left',
          width: '100%',
        }}
      >
        <Typography
          variant="caption"
          color="text.secondary"
          sx={{ fontWeight: 600 }}
        >
          Exploits
        </Typography>
        <IconButton size="small" sx={{ p: 0, ml: -0.5 }}>
          {expanded ? (
            <ExpandLessIcon fontSize="small" />
          ) : (
            <ExpandMoreIcon fontSize="small" />
          )}
        </IconButton>
      </Box>
      <Collapse in={expanded}>
      {adding && onAddExploit && (
        <Box sx={{ display: 'flex', gap: 0.5, mb: 1 }}>
          <TextField
            size="small"
            placeholder="Add exploit..."
            value={value}
            onChange={(e) => setValue(e.target.value)}
            onKeyDown={(e) => {
              if (e.key === 'Enter') handleAdd();
              if (e.key === 'Escape') {
                setAdding(false);
                setValue('');
              }
            }}
            autoFocus
            sx={{ flex: 1, '& .MuiInputBase-input': { fontSize: '0.9rem' } }}
          />
          <Box sx={{ display: 'flex', gap: 0.25 }}>
            <Button
              size="small"
              onClick={handleAdd}
              disabled={saving || !value.trim()}
            >
              Add
            </Button>
            <Button
              size="small"
              variant="text"
              color="inherit"
              onClick={() => { setAdding(false); setValue(''); }}
            >
              Cancel
            </Button>
          </Box>
        </Box>
      )}
      {!adding && onAddExploit && (
        <Box sx={{ mb: 1 }}>
          <IconButton
            size="small"
            onClick={() => setAdding(true)}
            disabled={saving}
            sx={{ p: 0.25 }}
            aria-label="Add exploit"
          >
            <AddIcon fontSize="small" />
          </IconButton>
        </Box>
      )}
      {exploits?.length > 0 && (
        <Box sx={{ color: EXPLOIT_COLOR, fontWeight: 600, fontSize: '0.9rem', lineHeight: 1.6 }}>
          {exploits?.map((e, i) => (
            <Box
              key={i}
              sx={{
                display: 'flex',
                alignItems: 'center',
                gap: 0.5,
                whiteSpace: 'pre-wrap',
                '&:hover .exploit-delete': { opacity: 1 },
              }}
            >
              <Box component="span" sx={{ flex: 1, wordBreak: 'break-word' }}>
                <RichNoteRenderer text={e} />
              </Box>
              {onDeleteExploit && (
                <IconButton
                  className="exploit-delete"
                  size="small"
                  onClick={() => onDeleteExploit(i)}
                  disabled={saving}
                  sx={{
                    opacity: 0,
                    p: 0.25,
                    transition: 'opacity 0.15s',
                    '&:hover': { opacity: 1 },
                  }}
                  aria-label="Delete exploit"
                >
                  <DeleteIcon fontSize="small" />
                </IconButton>
              )}
            </Box>
          ))}
        </Box>
      )}
      </Collapse>
      {!expanded && (
        <Typography variant="caption" color="text.secondary" sx={{ display: 'block', mt: -0.5 }}>
          {summary}
        </Typography>
      )}
    </Box>
  );
}
